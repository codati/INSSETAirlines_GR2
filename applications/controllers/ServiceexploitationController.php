<?php
class ServiceexploitationController extends Zend_Controller_Action
{
    public function init()
    {
        $this->headStyleScript = array(
                'css' => 'service_exploitation',
                'js' => 'service_exploitation'
        );

        if(!session_encours())
        {
            $redirector = $this->_helper->getHelper('Redirector');
            $redirector->gotoUrl($this->view->baseUrl());  
        }
    }

    public function gestionvolsAction()
    {
        $this->_helper->actionStack('header','index','default',array('head' => $this->headStyleScript));

        $tableLigne = new Table_Ligne;
        $lstLigneSql = $tableLigne->getLignes();
        //echo '<pre>';print_r($lstLigneSql);echo '</pre>';

        $lstLigne = array();
        foreach($lstLigneSql as $val) {$lstLigne[$val['idLigne']] = $val['depart'].' -> '.$val['arrivee'];}
        //echo '<pre>';print_r($lstLigne);echo '</pre>';

        $form = new Zend_Form;
        $form->setMethod('post');
        $form->setAttrib('id', 'ChoixLigne');

        $selectLigne = new Zend_Form_Element_Select('ligne');
        $selectLigne->setLabel('Choisissez une ligne : ');
        $selectLigne->addMultiOptions($lstLigne);
        $form->addElement($selectLigne);
        $form->addElement('hidden', 'load', array('value' => ''));

        $this->view->form = $form;
        $this->view->firstLigne = $lstLigneSql[0]['idLigne'];
    }

    public function gestionlstvolAction()
    {
        $ajax = $this->_getParam('ajax', null);
        $idLigne = $this->_getParam('Ligne', 0);

        if($ajax === null)
        {
            $ajax = true;

            //On change de layout pour pas avoir le header etc
            $layout = Zend_Layout::getMvcInstance();
            $layout->setLayout('api');
        }

        $tableVol = new Table_Vol;
        $lst = $tableVol->get_lstVol_EncoursEtAVenir_ligne($idLigne, false);

        foreach($lst as $key => $val)
        {
            if(!empty($val['dateHeureDepartPrevueVol'])) {$departPrevu = DateFormat_View(new Zend_Date($val['dateHeureDepartPrevueVol']));}
            else {$departPrevu = '';}

            if(!empty($val['dateHeureDepartEffectiveVol'])) {$departEffectif = DateFormat_View(new Zend_Date($val['dateHeureDepartEffectiveVol']));}
            else {$departEffectif = '';}

            if(!empty($val['dateHeureArriveePrevueVol'])) {$arrivePrevu = DateFormat_View(new Zend_Date($val['dateHeureArriveePrevueVol']));}
            else {$arrivePrevu = '';}

            if(!empty($val['dateHeureArriveeEffectiveVol'])) {$arriveEffectif = DateFormat_View(new Zend_Date($val['dateHeureArriveeEffectiveVol']));}
            else {$arriveEffectif = '';}

            $lst[$key]['DepartPrevu'] = $departPrevu;
            $lst[$key]['DepartEffectif'] = $departEffectif;
            $lst[$key]['ArriveePrevu'] = $arrivePrevu;
            $lst[$key]['ArriveeEffectif'] = $arriveEffectif;
        }

        $this->view->lst = $lst;
    }

    public function editremarqueAction()
    {
        //On change de layout pour pas avoir le header etc
        $layout = Zend_Layout::getMvcInstance();
        $layout->setLayout('api');

        $id = substr($this->_getParam('id', null), 4);
        $val = $this->_getParam('val', null);

        if($id != null && $val != null)
        {
                $tableVol = new Table_Vol;
                $tableVol->editRemarque($id, $val);
        }
    }
}
?>